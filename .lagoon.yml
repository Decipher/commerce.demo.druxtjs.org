docker-compose-yaml: 'docker-compose.yml'

project: druxtjs-org-demo-commerce

tasks:
  post-rollout:
    - run:
        name: drush si
        command: drush -y site:install commerce_kickstart
        service: cli

    - run:
        name: drush en
        command: drush -y pm:enable commerce_demo druxt
        service: cli

    - run:
        name: drush rap
        command: drush role:perm:add anonymous "access druxt resources"
        service: cli

    # - run:
    #     name: drush config:set
    #     command: |
    #       drush config:set druxt_node_preview.settings frontends "Production|https://demo.druxtjs.org/node/preview/[view_mode]#[jsonapi_node_preview]" -y
    #       drush config:set jsonapi.settings read_only 0 -y
    #     service: cli

    # - run:
    #     name: drush search-api:index
    #     command: drush search-api:index
    #     service: cli

    - run:
        name: drush mailer:import
        command: drush mailer:import
        service: cli

    - run:
        name: drush cache:rebuild
        command: drush cache:rebuild
        service: cli

    - run:
        name: drush user:login
        command: drush user:login
        service: cli

environments:
  staging/frontend:
    routes:
      - app:
          - staging.commerce.demo.druxtjs.org
      - storybook:
          - storybook.staging.commerce.demo.druxtjs.org
  staging/backend:
    routes:
      - nginx:
          - api.staging.commerce.demo.druxtjs.org
  production/frontend:
    routes:
      - app:
          - commerce.demo.druxtjs.org
      - storybook:
          - storybook.commerce.demo.druxtjs.org
  production/backend:
    routes:
      - nginx:
          - api.commerce.demo.druxtjs.org
    cronjobs:
      - name: drush cron
        schedule: "*/15 * * * *"
        command: drush cron
        service: cli
